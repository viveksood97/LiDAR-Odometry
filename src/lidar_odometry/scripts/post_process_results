#!/usr/bin/env python3

import argparse
import pandas as pd
import matplotlib.pyplot as plt
import os
import numpy as np
from datetime import datetime


def get_results_path():
    parser = argparse.ArgumentParser(description="Directory for results.")
    parser.add_argument("--results-dir", default="results", help="Path to the CSV file.")
    args = parser.parse_args()
    return args.results_dir

def main():
    results_dir = get_results_path()
    csv_path = os.path.join(results_dir, "trajectory_data.csv")
    if not os.path.exists(csv_path):
        print(f"Error: {csv_path} not found.")
        return

    df = pd.read_csv(csv_path)
    if df.empty: 
        print("Error: CSV is empty.")
        return

    # Calculate relative time
    time = df['timestamp_sec'] - df['timestamp_sec'].iloc[0]
    
    # Updated to 1 row, 3 columns to accommodate Yaw Error
    fig, (ax1, ax2, ax3) = plt.subplots(1, 3, figsize=(20, 6))

    # Plot 1: 2D Trajectory
    ax1.plot(df['gt_x'], df['gt_y'], 'k--', label='Ground Truth', alpha=0.7)
    ax1.plot(df['est_x'], df['est_y'], 'b-', label='Lidar Odometry', linewidth=2)
    ax1.set_title("2D Trajectory (Top-Down)")
    ax1.set_xlabel("X [m]")
    ax1.set_ylabel("Y [m]")
    ax1.legend()
    ax1.axis('equal') 
    ax1.grid(True)

    # Plot 2: 2D Translation Error
    ax2.fill_between(time, df['pos_err'], color='red', alpha=0.2)
    ax2.plot(time, df['pos_err'], 'r-', label='Pos Error (m)')
    rmse_pos = np.sqrt(np.mean(df['pos_err']**2))
    ax2.axhline(rmse_pos, color='darkred', linestyle=':', label=f'RMSE: {rmse_pos:.3f}m')
    ax2.set_title("2D Translation Error Over Time")
    ax2.set_xlabel("Time [s]")
    ax2.set_ylabel("Error [m]")
    ax2.legend()
    ax2.grid(True)

    # Plot 3: Yaw Error
    # Assuming 'yaw_err' exists in the CSV. 
    # If values are in radians, you might want to convert to degrees: df['yaw_err'] * (180/np.pi)
    ax3.fill_between(time, df['yaw_err'], color='green', alpha=0.2)
    ax3.plot(time, df['yaw_err'], 'g-', label='Yaw Error')
    rmse_yaw = np.sqrt(np.mean(df['yaw_err']**2))
    ax3.axhline(rmse_yaw, color='darkgreen', linestyle=':', label=f'RMSE: {rmse_yaw:.3f}')
    ax3.set_title("Yaw Error Over Time")
    ax3.set_xlabel("Time [s]")
    ax3.set_ylabel("Error [rad/deg]")
    ax3.legend()
    ax3.grid(True)

    plt.tight_layout()

    # Save and Open
    output_dir = os.path.join(results_dir)
    os.makedirs(output_dir, exist_ok=True)
    save_path = os.path.join(output_dir, f"2d_analysis_{datetime.now().strftime('%H%M%S')}.png")
    plt.savefig(save_path, dpi=300)
    plt.close(fig)
    
    print(f"[Post-Process] 2D plots (including Yaw) saved to: {save_path}")

if __name__ == '__main__':
    main()