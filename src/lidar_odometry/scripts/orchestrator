#!/usr/bin/env python3

import os
import subprocess
import time
import sys
from tqdm import tqdm

def get_bag_duration(bag_file):
    """Extracts the duration of the bag file in seconds."""
    try:
        # Get bag info in YAML format
        result = subprocess.run(
            ['ros2', 'bag', 'info', bag_file], 
            capture_output=True, text=True, check=True
        )
        # Simple parsing for Duration line (e.g., "Duration: 120.5s")
        for line in result.stdout.splitlines():
            if "Duration:" in line:
                # Extract numbers and decimal
                duration_str = line.split(":")[1].strip().split('s')[0]
                return float(duration_str)
    except Exception as e:
        print(f"Warning: Could not determine bag duration: {e}")
    return None

def run_orchestration():
    BAG_FILE = 'rosbag2_2025_10_27-16_39_13_0.db3'
    RESULTS_DIR = "results"


    os.makedirs(RESULTS_DIR, exist_ok=True)

    # 1. Start Launch File
    print("--- Starting Launch File ---")
    launch_proc = subprocess.Popen([
        'ros2', 'launch', 'lidar_odometry', 'lio.launch.py',
        'csv_filepath:=results/trajectory_data.csv'
    ])
    
    print("Waiting 2 seconds for nodes to initialize...")
    time.sleep(2)
    
    # 2. Get Duration for Progress Bar
    duration = get_bag_duration(BAG_FILE)
    
    # 3. Run the ROS bag with a progress bar
    print(f"\n--- Playing Rosbag: {BAG_FILE} ---\n")
    
    # Start the bag process in the background
    bag_proc = subprocess.Popen(
        ['ros2', 'bag', 'play', BAG_FILE, "--clock"], 
        stdout=subprocess.DEVNULL, 
        stderr=subprocess.DEVNULL
    )

    try:
        if duration:
            # Create progress bar
            with tqdm(total=100, desc="Progress", bar_format='{l_bar}{bar}| {n:.1f}% [{elapsed}<{remaining}]') as pbar:
                start_time = time.time()
                while bag_proc.poll() is None: # While process is running
                    elapsed = time.time() - start_time
                    progress = min((elapsed / duration) * 100, 100.0)
                    pbar.n = progress
                    pbar.refresh()
                    time.sleep(0.5)
                pbar.n = 100.0
                pbar.refresh()
        else:
            bag_proc.wait()

        print("\nRosbag playback finished.")
    except KeyboardInterrupt:
        print("\nUser interrupted. Shutting down...")
        bag_proc.terminate()
        launch_proc.terminate()
        sys.exit(1)

    # 4. Cleanup
    print("--- Killing Launch Nodes ---")
    launch_proc.terminate()
    launch_proc.wait()
    print("Nodes stopped.")

    # 5. Post-processing
    print("--- Running Post-Process Results ---")
    try:
        subprocess.run(['ros2', 'run', 'lidar_odometry', 'post_process_results'], check=True)
        print("Workflow complete.")
    except subprocess.CalledProcessError as e:
        print(f"Post-processing failed: {e}")

if __name__ == "__main__":
    run_orchestration()